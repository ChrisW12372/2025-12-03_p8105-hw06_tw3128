---
title: "2025-12-03_p8105_hw6_tw3128.Rmd"
author: "Chris"
date: "2025-12-03"
output: github_document
---

```{r include = FALSE}
library(tidyverse)
library(plotly)
library(janitor)
library(broom)
library(car)
library(MASS)
library(modelr)
```


# Problem One

```{r}
df_homicide <- read_csv("data/homicide-data.csv") |>
  clean_names()
```


## city_state

```{r}
df_homicide <- df_homicide |>
  mutate(city_state = paste(city, state, sep = ", ")) |>
  filter(!city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")) |>
  filter(victim_race %in% c("White", "Black")) |>
  mutate(
    victim_age = as.numeric(victim_age))
```



## Baltimore, MD


```{r}
df_baltimore <- df_homicide |>
  filter(city_state == "Baltimore, MD") |>
  mutate(
    resolved = ifelse(disposition == "Closed by arrest", 1, 0),
    victim_race = as.factor(victim_race),
    victim_sex = as.factor(victim_sex)
  )

model_lgt <- 
  glm(resolved ~ victim_age + victim_sex + victim_race, family = binomial, data = df_baltimore) 
result <- tidy(model_lgt, exponentiate = TRUE, conf.int = TRUE)
result
```

Keeping other factors fixed, the male victims have 0.4256 times odds of being resolved compared with female victims, and the 0.95 confidence interval is `[0.3241908, 0.5575508]`.  



## All Cities

```{r}
df_homicide <- df_homicide |>
   mutate(
    resolved = ifelse(disposition == "Closed by arrest", 1, 0),
    victim_race = as.factor(victim_race),
    victim_sex = as.factor(victim_sex)
  )

df_cities_results <- df_homicide |>
  group_by(city_state) |>
  nest() |>
  mutate(
    model = map(data, ~ glm(resolved ~ victim_age + victim_sex + victim_race,
                            data = .x, family = binomial)),
    tidy_res = map(model, ~ tidy(.x, exponentiate = TRUE,
                                 conf.int = TRUE))
  ) |>
  unnest(tidy_res) |>
  filter(term == "victim_sexMale") |> 
  dplyr::select(city_state, estimate, conf.low, conf.high)
```


## Make a Plot


```{r}
df_cities_results <- df_cities_results |>
  arrange(estimate) |>
  mutate(city_state = factor(city_state, levels = city_state)) 

df_cities_results |>
  ggplot(aes(x = estimate, y = city_state, color = city_state)) + 
  geom_point() +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.2) +
  geom_vline(xintercept = 1, linetype = "dashed") + 
  labs(
    x = "Adjusted Odds Ratio (Male vs Female Victims)",
    y = "City",
    title = "Adjusted OR for Homicide Clearance by Victim Sex Across Cities"
  ) +
  theme(axis.text.y = element_text(face = "italic"))
```


Most cities have an OR < 1, indicating lower odds of clearance for male victims compared to female victims.

Some cities show wide confidence intervals, suggesting uncertainty due to smaller sample sizes.   
Cities where the CI crosses 1.0 suggest no strong evidence of a sex difference in clearance odds.  


# Problem Two


```{r}
library(p8105.datasets)
data(weather_df)
```



## Fit One Linear Model


```{r}
mlr_fit <- lm(tmax ~ tmin + prcp, data = weather_df)
summary(mlr_fit)


# extracting some outcomes
r_square_hat <- summary(mlr_fit)$r.squared

coef_hat <- coef(mlr_fit)
beta1_hat <- coef_hat["tmin"]
beta2_hat <- coef_hat["prcp"]

ratio_hat <- beta1_hat / beta2_hat
r_square_hat
ratio_hat
```


## A Function

```{r}
boot_start <- function(data) {
  fit <- lm(tmax ~ tmin + prcp, data = data)
  
  r2 <- summary(fit)$r.squared
  beta <- coef(fit)
  ratio <- beta["tmin"] / beta["prcp"]
  
  c(r2 = r2, ratio = ratio)
}

boot_start(weather_df)
```



## Bootstrap

```{r}
set.seed(20251203)

n_boot <- 5000
n <- nrow(weather_df)

boot_results <- 
  replicate(n_boot, {
    df_boot <- weather_df[sample(1:n, n, replace = TRUE), ]
    boot_start(df_boot)
  })

boot_results <- t(boot_results) |>
  as.data.frame()
```


## Make a Plot

```{r}
boot_results_long <- 
  boot_results |>
  pivot_longer(cols = everything(),
               names_to = "statistic",
               values_to = "value")

ggplot(boot_results_long, aes(x = value)) +
  geom_histogram(bins = 30, fill = "steelblue", alpha = 0.7) +
  facet_wrap(~ statistic, scales = "free") +
  theme_minimal() +
  labs(
    title = "Bootstrap Distributions of R² and β1/β2",
    x = "Value",
    y = "Frequency"
  )


CI_r2 <- quantile(boot_results$r2, c(0.025, 0.975))
CI_ratio <- quantile(boot_results$ratio, c(0.025, 0.975))

CI_r2
CI_ratio
```


The figure shows the bootstrap distributions of the coefficient of determination r^2 and the regression coefficient ratio beta1^hat / beta2^hat. The bootstrap distribution of r^2 is fairly narrow and approximately symmetric around values close to 0.94, indicating that the model consistently explains a large proportion of variability in maximum temperature across resampled datasets. This suggests that the model fit is highly stable.  

In contrast, the distribution of beta1^hat / beta2^hat shows greater spread and noticeable left-skewness. This indicates more uncertainty in the relative strength between the effects of minimum temperature and precipitation on maximum temperature. The larger sampling variability suggests that the effect ratio is less stable and potentially more sensitive to the specific observations included in the dataset.  



# Problem Three

```{r}
df_bwt <- read_csv("data/birthweight.csv") |>
  clean_names() |>
  mutate(
    babysex = as.factor(babysex)
    
  )
```


## The Basic Model

```{r}
basic_mlr <- lm(bwt ~ babysex + blength + gaweeks + ppbmi + smoken + wtgain, data = df_bwt)
summary(basic_mlr)
vif(basic_mlr)
```

I began constructing a regression model for birthweight using predictors supported by existing medical and biological evidence.
Specifically, we included:

* `babysex` — sex differences in fetal growth are well-documented; on average, male infants tend to have higher birthweight.

* `blength` — birth length is a direct indicator of fetal physical growth and is strongly associated with weight at delivery.

* `gaweeks` — longer gestational age allows more time for fetal development, contributing to higher birthweight.

* `ppbmi` — maternal pre-pregnancy nutritional status influences fetal growth through placental resource supply.

* `smoken` — cigarette exposure during pregnancy reduces fetal oxygenation and is a well-known risk factor for low birthweight.

* `wtgain` — gestational weight gain reflects nutritional intake during pregnancy and is positively related to fetal growth.

These predictors were chosen in advance based on biological plausibility rather than purely statistical significance.
Variance inflation factors for all predictors were below 2, indicating no concerning multicollinearity.
Therefore, this model provides a reasonable and interpretable foundation for further model refinement.



## Stepwise Method

```{r}
step_mod <- stepAIC(basic_mlr, direction = "both", trace = FALSE)
summary(step_mod)
```


I applied a stepwise model selection approach using AIC (stepAIC), but no additional predictors were selected and no terms were removed. This result indicates that the initial model already achieves a near-optimal balance between model fit and complexity.
Therefore, I retained the original set of predictors for further evaluation and interpretation.


## Diagnostic

```{r}
df_bwt_reg <- df_bwt |>
 add_predictions(basic_mlr) |>
 add_residuals(basic_mlr)
  
```


```{r}
df_bwt_reg |>
  ggplot(aes(x = pred, y = resid)) + geom_point(alpha = 0.4) +
  geom_hline(yintercept = 0, color = "red") +
  theme_minimal() +
  labs(title = "Residual vs Fitted Plot: Basic Model",
       x = "Fitted birthweight",
       y = "Residual")

```



## Two Other Models

```{r}
model1 <- lm(bwt ~ blength + gaweeks, data = df_bwt)
summary(model1)
```


```{r}
model2 <- lm(bwt ~ bhead * blength * babysex, data = df_bwt)
summary(model2)
```


## Comparisons

```{r}
set.seed(20251203)

cv_df <- crossv_mc(df_bwt, 50) |>  
  mutate(
    train = map(train, as_tibble),
    test  = map(test,  as_tibble),

    
    mod_A     = map(train, ~ lm(bwt ~ blength + gaweeks, data = .x)),
    mod_basic = map(train, ~ lm(bwt ~ babysex + blength + gaweeks + ppbmi + smoken + wtgain, data = .x)),
    mod_B     = map(train, ~ lm(bwt ~ bhead * blength * babysex, data = .x)),

    
    rmse_A     = map2_dbl(mod_A,     test, ~ sqrt(mean((predict(.x, newdata = .y) - .y$bwt)^2))),
    rmse_basic = map2_dbl(mod_basic, test, ~ sqrt(mean((predict(.x, newdata = .y) - .y$bwt)^2))),
    rmse_B     = map2_dbl(mod_B,     test, ~ sqrt(mean((predict(.x, newdata = .y) - .y$bwt)^2)))
  )

cv_results <- cv_df |>
  summarise(
    rmse_A     = mean(rmse_A),
    rmse_basic = mean(rmse_basic),
    rmse_B     = mean(rmse_B)
  ) |>
  pivot_longer(everything(),
               names_to = "model",
               values_to = "mean_rmse")

cv_results
```


Based on the cross-validated RMSE, the fully interacted model (including head circumference, length, sex, and all interactions) produced the lowest prediction error, indicating the best predictive performance.

However, this model is extremely complex, includes a three-way interaction, and is difficult to interpret scientifically.

The proposed model achieves a reasonable trade-off between prediction accuracy and interpretability, performing substantially better than the simple baseline model and only moderately worse than the highly complex alternative.

Therefore, we would recommend our model for practical use, as it captures important biological predictors while maintaining clarity in how each factor relates to birthweight.
















