---
title: "2025-12-03_p8105_hw6_tw3128.Rmd"
author: "Chris"
date: "2025-12-03"
output: github_document
---

```{r include = FALSE}
library(tidyverse)
library(plotly)
library(janitor)
library(broom)
```


# Problem One

```{r}
df_homicide <- read_csv("data/homicide-data.csv") |>
  clean_names()
```


## city_state

```{r}
df_homicide <- df_homicide |>
  mutate(city_state = paste(city, state, sep = ", ")) |>
  filter(!city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")) |>
  filter(victim_race %in% c("White", "Black")) |>
  mutate(
    victim_age = as.numeric(victim_age))
```



## Baltimore, MD


```{r}
df_baltimore <- df_homicide |>
  filter(city_state == "Baltimore, MD") |>
  mutate(
    resolved = ifelse(disposition == "Closed by arrest", 1, 0),
    victim_race = as.factor(victim_race),
    victim_sex = as.factor(victim_sex)
  )

model_lgt <- 
  glm(resolved ~ victim_age + victim_sex + victim_race, family = binomial, data = df_baltimore) 
result <- tidy(model_lgt, exponentiate = TRUE, conf.int = TRUE)
result
```

Keeping other factors fixed, the male victims have 0.4256 times odds of being resolved compared with female victims, and the 0.95 confidence interval is `[0.3241908, 0.5575508]`.  



## All Cities

```{r}
df_homicide <- df_homicide |>
   mutate(
    resolved = ifelse(disposition == "Closed by arrest", 1, 0),
    victim_race = as.factor(victim_race),
    victim_sex = as.factor(victim_sex)
  )

df_cities_results <- df_homicide |>
  group_by(city_state) |>
  nest() |>
  mutate(
    model = map(data, ~ glm(resolved ~ victim_age + victim_sex + victim_race,
                            data = .x, family = binomial)),
    tidy_res = map(model, ~ tidy(.x, exponentiate = TRUE,
                                 conf.int = TRUE))
  ) |>
  unnest(tidy_res) |>
  filter(term == "victim_sexMale") |> 
  select(city_state, estimate, conf.low, conf.high)
```


## Make a Plot


```{r}
df_cities_results <- df_cities_results |>
  arrange(estimate) |>
  mutate(city_state = factor(city_state, levels = city_state)) 

df_cities_results |>
  ggplot(aes(x = estimate, y = city_state, color = city_state)) + 
  geom_point() +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.2) +
  geom_vline(xintercept = 1, linetype = "dashed") + 
  labs(
    x = "Adjusted Odds Ratio (Male vs Female Victims)",
    y = "City",
    title = "Adjusted OR for Homicide Clearance by Victim Sex Across Cities"
  ) +
  theme(axis.text.y = element_text(face = "italic"))
```


Most cities have an OR < 1, indicating lower odds of clearance for male victims compared to female victims.

Some cities show wide confidence intervals, suggesting uncertainty due to smaller sample sizes.   

Cities where the CI crosses 1.0 suggest no strong evidence of a sex difference in clearance odds.  


# Problem Two


```{r}
library(p8105.datasets)
data(weather_df)
```



## Fit One Linear Model


```{r}
mlr_fit <- lm(tmax ~ tmin + prcp, data = weather_df)
summary(mlr_fit)


# extracting some outcomes
r_square_hat <- summary(mlr_fit)$r.squared

coef_hat <- coef(mlr_fit)
beta1_hat <- coef_hat["tmin"]
beta2_hat <- coef_hat["prcp"]

ratio_hat <- beta1_hat / beta2_hat
r_square_hat
ratio_hat
```


## A Function

```{r}
boot_start <- function(data) {
  fit <- lm(tmax ~ tmin + prcp, data = data)
  
  r2 <- summary(fit)$r.squared
  beta <- coef(fit)
  ratio <- beta["tmin"] / beta["prcp"]
  
  c(r2 = r2, ratio = ratio)
}

boot_start(weather_df)
```



## Bootstrap

```{r}
set.seed(20251203)

n_boot <- 5000
n <- nrow(weather_df)

boot_results <- 
  replicate(n_boot, {
    df_boot <- weather_df[sample(1:n, n, replace = TRUE), ]
    boot_start(df_boot)
  })

boot_results <- t(boot_results) |>
  as.data.frame()
```


## Make a Plot

```{r}
boot_results_long <- 
  boot_results |>
  pivot_longer(cols = everything(),
               names_to = "statistic",
               values_to = "value")

ggplot(boot_results_long, aes(x = value)) +
  geom_histogram(bins = 30, fill = "steelblue", alpha = 0.7) +
  facet_wrap(~ statistic, scales = "free") +
  theme_minimal() +
  labs(
    title = "Bootstrap Distributions of R² and β1/β2",
    x = "Value",
    y = "Frequency"
  )


CI_r2 <- quantile(boot_results$r2, c(0.025, 0.975))
CI_ratio <- quantile(boot_results$ratio, c(0.025, 0.975))

CI_r2
CI_ratio
```


The figure shows the bootstrap distributions of the coefficient of determination r^2 and the regression coefficient ratio beta1^hat / beta2^hat. The bootstrap distribution of r^2 is fairly narrow and approximately symmetric around values close to 0.94, indicating that the model consistently explains a large proportion of variability in maximum temperature across resampled datasets. This suggests that the model fit is highly stable.  

In contrast, the distribution of beta1^hat / beta2^hat shows greater spread and noticeable left-skewness. This indicates more uncertainty in the relative strength between the effects of minimum temperature and precipitation on maximum temperature. The larger sampling variability suggests that the effect ratio is less stable and potentially more sensitive to the specific observations included in the dataset.  















